name: Quarterly Politician Maintenance Reminder

on:
  schedule:
    # Run quarterly: Jan 15, Apr 15, Jul 15, Oct 15 at 9:00 AM UTC
    - cron: '0 9 15 1,4,7,10 *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  create-maintenance-reminder:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install pandas numpy

      - name: Check current politician status
        id: check_status
        run: |
          cd jobs
          python3 << 'EOF'
          import sys
          sys.path.insert(0, '.')
          try:
              from politician_tracker import PoliticianTracker
              tracker = PoliticianTracker()
              stats = tracker.get_summary_stats()

              print(f"::set-output name=total::{stats['total_politicians']}")
              print(f"::set-output name=active::{stats['active']}")
              print(f"::set-output name=retiring::{stats['retiring']}")
              print(f"::set-output name=retired::{stats['retired']}")

              # Get retiring politicians list
              retiring = tracker.get_retiring_politicians()
              retiring_list = ', '.join(retiring) if retiring else 'None'
              print(f"::set-output name=retiring_list::{retiring_list}")

          except Exception as e:
              print(f"Error: {e}")
              print("::set-output name=total::unknown")
          EOF

      - name: Create maintenance reminder issue
        uses: actions/github-script@v6
        with:
          script: |
            const quarter = {
              1: 'Q1',
              4: 'Q2',
              7: 'Q3',
              10: 'Q4'
            }[new Date().getMonth() + 1];

            const year = new Date().getFullYear();

            const total = '${{ steps.check_status.outputs.total }}';
            const active = '${{ steps.check_status.outputs.active }}';
            const retiring = '${{ steps.check_status.outputs.retiring }}';
            const retired = '${{ steps.check_status.outputs.retired }}';
            const retiringList = '${{ steps.check_status.outputs.retiring_list }}';

            const body = `## ðŸ“… Quarterly Politician Status Maintenance - ${quarter} ${year}

            It's time for your quarterly politician status review! This ensures the time-decay system has accurate information for weighting politician trades.

            ### Current Status
            - **Total Politicians Tracked:** ${total}
            - **Active:** ${active}
            - **Retiring:** ${retiring}
            - **Retired:** ${retired}

            ${retiring !== '0' ? `âš ï¸ **Retiring Politicians:** ${retiringList}\n(Check if any have left office)` : ''}

            ---

            ## âœ… Maintenance Checklist

            ### 1. Check Information Sources
            - [ ] Review [congress.gov/members](https://www.congress.gov/members) for current members
            - [ ] Check recent news for retirement announcements (last 3 months)
            - [ ] Review [Capitol Trades](https://www.capitoltrades.com) for new high-volume traders
            - [ ] Verify any "retiring" politicians have left office

            ### 2. Identify Changes Needed
            Document any changes below:
            - [ ] Politicians announcing retirement (set to "retiring" for 1.5x boost)
            - [ ] Politicians who left office (set to "retired" for time-decay)
            - [ ] New high-volume traders to add
            - [ ] Politicians returning to office (rare)

            ### 3. Run Update Script
            \`\`\`bash
            # View current status
            python jobs/view_politician_status.py --sort weight

            # Edit update script with changes
            nano jobs/update_politician_status.py
            # (Update the UPDATES dictionary)

            # Run update
            python jobs/update_politician_status.py

            # Review changes and confirm
            \`\`\`

            ### 4. Commit Changes
            \`\`\`bash
            git add data/politician_registry.json
            git commit -m "Quarterly politician status update - ${quarter} ${year}"
            git push
            \`\`\`

            ### 5. Verify Next Run
            - [ ] Check next daily pipeline run shows updated statuses
            - [ ] Verify weights are applied correctly in logs

            ---

            ## ðŸ“š Resources

            - **Quick Guide:** [docs/POLITICIAN_TOOLS_README.md](docs/POLITICIAN_TOOLS_README.md)
            - **Full Guide:** [docs/POLITICIAN_MAINTENANCE_GUIDE.md](docs/POLITICIAN_MAINTENANCE_GUIDE.md)
            - **Update Script:** [jobs/update_politician_status.py](jobs/update_politician_status.py)
            - **View Tool:** [jobs/view_politician_status.py](jobs/view_politician_status.py)

            ---

            ## ðŸ—“ï¸ Next Review
            **${quarter === 'Q1' ? 'April 15' : quarter === 'Q2' ? 'July 15' : quarter === 'Q3' ? 'October 15' : 'January 15'}** (next quarter)

            ---

            *This is an automated quarterly reminder. Close this issue when maintenance is complete.*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ“… Quarterly Politician Maintenance - ${quarter} ${year}`,
              body: body,
              labels: ['maintenance', 'automated-reminder', 'politician-tracking']
            });

      - name: Summary
        run: |
          echo "âœ… Quarterly maintenance reminder issue created!"
          echo "ðŸ“‹ Check the Issues tab for the maintenance checklist"
